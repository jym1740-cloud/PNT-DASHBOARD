"use client";
import React, { useState, useMemo, useEffect } from "react";

// CSSëŠ” app/globals.cssì—ì„œ í†µí•© ê´€ë¦¬

import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { motion } from "framer-motion";
import { FileText, TrendingUp, AlertTriangle, Clock, DollarSign, Map, HelpCircle } from "lucide-react";
import WorldMap from "@/components/WorldMap";
import ProjectTable from "@/components/ProjectTable";
import StatusOverview from "@/components/StatusOverview";
import DashboardHeader from "@/components/DashboardHeader";
import FloatingActions from "@/components/FloatingActions";
import EquipmentHistoryTable from "@/components/EquipmentHistoryTable";



import { filterProjects, calculateStats } from "@/lib/projectUtils";
import { seedProjects } from "@/lib/sampleData";
import { Project, ProjectStatus } from "@/lib/types";

export default function CompanyOpsDashboard() {
  const [mounted, setMounted] = useState(false);
  const [projects, setProjects] = useState(seedProjects);
  const [query, setQuery] = useState("");
  const [statusFilter, setStatusFilter] = useState<string | undefined>(undefined);
  const [equipmentHistory, setEquipmentHistory] = useState<any[]>([]);
  const [equipmentHistoryOpen, setEquipmentHistoryOpen] = useState(false);
  
  // í”„ë¡œì íŠ¸ í¸ì§‘ì„ ìœ„í•œ ìƒíƒœ
  const [selected, setSelected] = useState<any | null>(null);
  const [open, setOpen] = useState(false);
  
  // ì¼ì • ê´€ë¦¬ë¥¼ ìœ„í•œ ìƒíƒœ
  const [scheduleOpen, setScheduleOpen] = useState(false);
  const [selectedSchedule, setSelectedSchedule] = useState<any | null>(null);
  const [scheduleItems, setScheduleItems] = useState<any[]>([]);
  const [people, setPeople] = useState<Array<{ id: string; name: string; affiliation: string; department: string }>>([]);


  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ í™•ì¸
  useEffect(() => {
    setMounted(true);
  }, []);

  // í”„ë¡œì íŠ¸ í¸ì§‘ í•¸ë“¤ëŸ¬
  function onEdit(p: any) {
    setSelected({ ...p });
    setEquipmentHistory(p.equipmentHistory || []);
    setOpen(true);
  }

  // ì¼ì • ê´€ë¦¬ í•¸ë“¤ëŸ¬
  function onSchedule(p: any) {
    setSelectedSchedule({ ...p });
    setScheduleItems(p.scheduleItems || []);
    // ì´ˆê¸° ì¸ì› ëª©ë¡ êµ¬ì„±: ì €ì¥ëœ peopleë§Œ ì‚¬ìš©, ê¸°ë³¸ ì¸ì› ìƒì„± ì•ˆí•¨
    const initialPeople: Array<{ id: string; name: string; affiliation: string; department: string }> = (p.people && Array.isArray(p.people))
      ? p.people
      : [];
    setPeople(initialPeople);
    setScheduleOpen(true);
  }

  // ì¥ë¹„ ì´ë ¥ í•¸ë“¤ëŸ¬
  function onEquipmentHistory(p: any) {
    setSelected({ ...p });
    setEquipmentHistory(p.equipmentHistory || []);
    setEquipmentHistoryOpen(true);
  }

  // í”„ë¡œì íŠ¸ ì‚­ì œ í•¸ë“¤ëŸ¬
  function onDelete(id: string) {
    setProjects((prev) => prev.filter((p) => p.id !== id));
  }

  // í”„ë¡œì íŠ¸ ì €ì¥ í•¸ë“¤ëŸ¬
  function onSave() {
    // íˆ¬ì…ë¥  ê³„ì‚° ë° ìƒíƒœ ìë™ ë³€ê²½
    let updatedProject = { ...selected, equipmentHistory };
    if (updatedProject.budget > 0) {
      const costRatio = (updatedProject.actualCost / updatedProject.budget) * 100;
      if (costRatio > 70) {
        updatedProject.status = "ì§„í–‰ ì¤‘(ê´€ë¦¬í•„ìš”)";
      }
    }
    
    setProjects((prev) => {
      const exists = prev.some((p) => p.id === selected.id);
      if (exists) return prev.map((p) => (p.id === selected.id ? updatedProject : p));
      return [updatedProject, ...prev];
    });
    setOpen(false);
  }

  // ì¼ì • ì €ì¥ í•¸ë“¤ëŸ¬
  function saveSchedule() {
    if (selectedSchedule) {
      // ì„ íƒëœ í”„ë¡œì íŠ¸ì˜ ì¼ì • í•­ëª© ì—…ë°ì´íŠ¸
      const updatedProject = {
        ...selectedSchedule,
        scheduleItems: scheduleItems,
        people: people
      };
      
      // í”„ë¡œì íŠ¸ ëª©ë¡ ì—…ë°ì´íŠ¸
      setProjects(prev => prev.map(p => 
        p.id === selectedSchedule.id ? updatedProject : p
      ));
      
      // ì„±ê³µ ë©”ì‹œì§€
      alert('ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
  }

  // í”„ë¡œì íŠ¸ í•„í„°ë§
  const filteredProjects = useMemo(() => 
    filterProjects(projects, query, statusFilter), 
    [projects, query, statusFilter]
  );

  // í†µê³„ ê³„ì‚°
  const stats = useMemo(() => calculateStats(projects), [projects]);

  // í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸ í•¸ë“¤ëŸ¬
  const handleProjectUpdate = (updatedProjects: Project[]) => {
    setProjects(updatedProjects);
  };





  if (!mounted) return null;

  return (
    <>
      <div className="min-h-screen bg-gray-50">
        {/* í—¤ë” */}
        <DashboardHeader 
          query={query}
          onQueryChange={setQuery}
          statusFilter={statusFilter}
          onStatusFilterChange={setStatusFilter}
          onCreate={() => {
            // í”„ë¡œì íŠ¸ ìƒì„± í›„ í”„ë¡œì íŠ¸ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.querySelector('#projects-section')?.scrollIntoView({ behavior: 'smooth' });
          }}
          onHelpOpen={() => {}}
        />

        {/* ë©”ì¸ ì»¨í…ì¸  */}
        <main className="max-w-7xl mx-auto p-6 space-y-6">
          {/* í†µê³„ ê°œìš” */}
          <StatusOverview projects={projects} />

          {/* ê²€ìƒ‰ ë° í•„í„° */}
          <div className="flex flex-col sm:flex-row gap-4">
            <div className="flex-1">
              <Input
                placeholder="í”„ë¡œì íŠ¸ ê²€ìƒ‰..."
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                className="w-full"
              />
            </div>
            <Select value={statusFilter || "all"} onValueChange={(value) => setStatusFilter(value === "all" ? undefined : value)}>
              <SelectTrigger className="w-full sm:w-48">
                <SelectValue placeholder="ìƒíƒœë³„ í•„í„°" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">ì „ì²´</SelectItem>
                <SelectItem value="planning">ê³„íš</SelectItem>
                <SelectItem value="active">ì§„í–‰ì¤‘</SelectItem>
                <SelectItem value="management">ê´€ë¦¬</SelectItem>
                <SelectItem value="hold">ë³´ë¥˜</SelectItem>
                <SelectItem value="completed">ì™„ë£Œ</SelectItem>
              </SelectContent>
            </Select>
          </div>

          {/* ì›”ë“œë§µ ì„¹ì…˜ */}
          <div id="overview-section" className="space-y-6">
            <div className="flex items-center gap-2">
              <Map className="w-6 h-6 text-blue-600" />
              <h2 className="text-2xl font-bold text-gray-900">ì›”ë“œë§µ</h2>
            </div>
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.3 }}
            >
              <WorldMap projects={filteredProjects} />
            </motion.div>
          </div>

          {/* í”„ë¡œì íŠ¸ í…Œì´ë¸” ì„¹ì…˜ */}
          <div id="projects-section" className="space-y-6">
            <div className="flex items-center gap-2">
              <FileText className="w-6 h-6 text-green-600" />
              <h2 className="text-2xl font-bold text-gray-900">í”„ë¡œì íŠ¸ ëª©ë¡</h2>
            </div>
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.3 }}
              className="space-y-6"
            >
              <ProjectTable 
                projects={filteredProjects}
                onEdit={onEdit}
                onSchedule={onSchedule}
                onEquipmentHistory={onEquipmentHistory}
                onDelete={onDelete}
              />
            </motion.div>
          </div>

          



          {/* í”Œë¡œíŒ… ì•¡ì…˜ */}
          <FloatingActions
            onCreate={() => {
              // í”„ë¡œì íŠ¸ ìƒì„± í›„ í”„ë¡œì íŠ¸ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
              document.querySelector('#projects-section')?.scrollIntoView({ behavior: 'smooth' });
            }}
            onOverview={() => {
              // ì›”ë“œë§µ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
              document.querySelector('#overview-section')?.scrollIntoView({ behavior: 'smooth' });
            }}
            onProjects={() => {
              // í”„ë¡œì íŠ¸ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
              document.querySelector('#projects-section')?.scrollIntoView({ behavior: 'smooth' });
            }}
          />
        </main>

        {/* ì¥ë¹„ ì´ë ¥ ë‹¤ì´ì–¼ë¡œê·¸ */}
        {equipmentHistoryOpen && (
          <EquipmentHistoryTable
            equipmentHistory={equipmentHistory}
            onUpdate={(id, field, value) => {
              // ì¥ë¹„ ì´ë ¥ ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„ í•„ìš”
              console.log('Update equipment history:', id, field, value);
            }}
            onDelete={(id) => {
              // ì¥ë¹„ ì´ë ¥ ì‚­ì œ ë¡œì§ êµ¬í˜„ í•„ìš”
              console.log('Delete equipment history:', id);
            }}
          />
        )}

        {/* í”„ë¡œì íŠ¸ í¸ì§‘ ëª¨ë‹¬ */}
        {open && selected && (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">
                  {selected.pjtNo ? "í”„ë¡œì íŠ¸ ìˆ˜ì •" : "ì‹ ê·œ í”„ë¡œì íŠ¸"}
                </h2>
                <button
                  onClick={() => setOpen(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  âœ•
                </button>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">PJT NO</label>
                  <Input
                    value={selected.pjtNo || ""}
                    onChange={(e) => setSelected({ ...selected, pjtNo: e.target.value })}
                    placeholder="ì˜ˆ: PJT-25001"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">í”„ë¡œì íŠ¸ëª…</label>
                  <Input
                    value={selected.name || ""}
                    onChange={(e) => setSelected({ ...selected, name: e.target.value })}
                    placeholder="ì˜ˆ: Dryer Retrofit"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                  <Select
                    value={selected.status || "ê³„íš"}
                    onValueChange={(value) => setSelected({ ...selected, status: value })}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="ê³„íš">ê³„íš</SelectItem>
                      <SelectItem value="ì§„í–‰ ì¤‘">ì§„í–‰ ì¤‘</SelectItem>
                      <SelectItem value="ì§„í–‰ ì¤‘(ê´€ë¦¬í•„ìš”)">ì§„í–‰ ì¤‘(ê´€ë¦¬í•„ìš”)</SelectItem>
                      <SelectItem value="ì¼ì‹œ ì¤‘ë‹¨">ì¼ì‹œ ì¤‘ë‹¨</SelectItem>
                      <SelectItem value="ì™„ë£Œ">ì™„ë£Œ</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">PM</label>
                  <Input
                    value={selected.pm || ""}
                    onChange={(e) => setSelected({ ...selected, pm: e.target.value })}
                    placeholder="í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ì˜ˆì‚° (KRW)</label>
                  <Input
                    type="number"
                    value={selected.budget || 0}
                    onChange={(e) => setSelected({ ...selected, budget: Number(e.target.value) })}
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">íˆ¬ì…ì›ê°€ (KRW)</label>
                  <Input
                    type="number"
                    value={selected.actualCost || 0}
                    onChange={(e) => setSelected({ ...selected, actualCost: Number(e.target.value) })}
                    placeholder="ì‹¤ì œ ì§€ì¶œëœ ë¹„ìš©"
                  />
                  {selected.budget > 0 && (
                    <div className="mt-2 p-2 bg-gray-50 rounded text-xs">
                      <div className="flex justify-between items-center mb-1">
                        <span className="text-gray-600">í˜„ì¬ íˆ¬ì…ë¥ :</span>
                        <span className={`font-medium ${(selected.actualCost / selected.budget) * 100 > 80 ? 'text-red-600' : (selected.actualCost / selected.budget) * 100 > 70 ? 'text-amber-600' : 'text-green-600'}`}>
                          {((selected.actualCost / selected.budget) * 100).toFixed(1)}%
                        </span>
                      </div>
                    </div>
                  )}
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ë¹„ê³ </label>
                  <textarea
                    value={selected.note || ""}
                    onChange={(e) => setSelected({ ...selected, note: e.target.value })}
                    placeholder="ë©”ëª¨"
                    className="w-full p-2 border border-gray-300 rounded-md resize-none"
                    rows={3}
                  />
                </div>
              </div>
              
              <div className="flex justify-end gap-2 mt-6">
                <Button variant="outline" onClick={() => setOpen(false)}>
                  ì·¨ì†Œ
                </Button>
                <Button onClick={onSave}>
                  ì €ì¥
                </Button>
              </div>
            </div>
          </div>
        )}

        {/* ì¼ì • ê´€ë¦¬ ëª¨ë‹¬ */}
        {scheduleOpen && selectedSchedule && (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">
                  ì¼ì • ê´€ë¦¬ - {selectedSchedule.name || "í”„ë¡œì íŠ¸"}
                </h2>
                <button
                  onClick={() => setScheduleOpen(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  âœ•
                </button>
              </div>
              
              <div className="space-y-4">
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="font-medium text-gray-700">í”„ë¡œì íŠ¸ ë²ˆí˜¸:</span>
                      <span className="ml-2 text-gray-600">{selectedSchedule.pjtNo}</span>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">ìƒíƒœ:</span>
                      <span className="ml-2 text-sm font-medium text-gray-900">
                        {selectedSchedule.status || "ìƒíƒœ ì—†ìŒ"}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-lg font-medium">ì¼ì • í•­ëª©</h3>
                    <Button
                      onClick={() => {
                        const newItem = {
                          id: Math.random().toString(36).slice(2),
                          name: "ìƒˆ ì¼ì •",
                          startDate: "",
                          endDate: "",
                          progress: 0
                        };
                        setScheduleItems(prev => [...prev, newItem]);
                      }}
                      size="sm"
                    >
                      + ì¼ì • ì¶”ê°€
                    </Button>
                  </div>
                  
                  <div className="space-y-2">
                    {scheduleItems.map((item, index) => (
                      <div key={item.id} className="flex gap-2 p-2 border rounded">
                        <Input
                          value={item.name}
                          onChange={(e) => {
                            const newItems = [...scheduleItems];
                            newItems[index].name = e.target.value;
                            setScheduleItems(newItems);
                          }}
                          placeholder="ì¼ì •ëª…"
                          className="flex-1"
                        />
                        <Input
                          type="date"
                          value={item.startDate}
                          onChange={(e) => {
                            const newItems = [...scheduleItems];
                            newItems[index].startDate = e.target.value;
                            setScheduleItems(newItems);
                          }}
                        />
                        <Input
                          type="date"
                          value={item.endDate}
                          onChange={(e) => {
                            const newItems = [...scheduleItems];
                            newItems[index].endDate = e.target.value;
                            setScheduleItems(newItems);
                          }}
                        />
                        <Input
                          type="number"
                          min="0"
                          max="100"
                          value={item.progress}
                          onChange={(e) => {
                            const newItems = [...scheduleItems];
                            newItems[index].progress = parseInt(e.target.value) || 0;
                            setScheduleItems(newItems);
                          }}
                          className="w-20"
                          placeholder="%"
                        />
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setScheduleItems(prev => prev.filter((_, i) => i !== index));
                          }}
                        >
                          ì‚­ì œ
                        </Button>
                      </div>
                    ))}
                  </div>
                </div>
                
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-lg font-medium">ë‹´ë‹¹ì</h3>
                    <Button
                      onClick={() => {
                        const newPerson = { 
                          id: Math.random().toString(36).slice(2), 
                          name: '', 
                          affiliation: 'í”¼ì—”í‹°', 
                          department: '' 
                        };
                        setPeople(prev => [...prev, newPerson]);
                      }}
                      size="sm"
                    >
                      + ë‹´ë‹¹ì ì¶”ê°€
                    </Button>
                  </div>
                  
                  <div className="space-y-2">
                    {people.map((person, index) => (
                      <div key={person.id} className="flex gap-2 p-2 border rounded">
                        <Input
                          value={person.name}
                          onChange={(e) => {
                            const newPeople = [...people];
                            newPeople[index].name = e.target.value;
                            setPeople(newPeople);
                          }}
                          placeholder="ì´ë¦„"
                          className="flex-1"
                        />
                        <Input
                          value={person.affiliation}
                          onChange={(e) => {
                            const newPeople = [...people];
                            newPeople[index].affiliation = e.target.value;
                            setPeople(newPeople);
                          }}
                          placeholder="ì†Œì†"
                          className="flex-1"
                        />
                        <Input
                          value={person.department}
                          onChange={(e) => {
                            const newPeople = [...people];
                            newPeople[index].department = e.target.value;
                            setPeople(newPeople);
                          }}
                          placeholder="ë¶€ì„œ"
                          className="flex-1"
                        />
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setPeople(prev => prev.filter((_, i) => i !== index));
                          }}
                        >
                          ì‚­ì œ
                        </Button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              
              <div className="flex justify-end gap-2 mt-6">
                <Button variant="outline" onClick={() => setScheduleOpen(false)}>
                  ì·¨ì†Œ
                </Button>
                <Button onClick={saveSchedule}>
                  ì €ì¥
                </Button>
              </div>
            </div>
          </div>
        )}

        {/* Footer */}
        <footer className="max-w-7xl mx-auto p-6 text-xs text-zinc-500 space-y-1">
          <div>â“˜ í”„ë¡œí† íƒ€ì…: ë¡œì»¬ ìƒíƒœë¡œ ë™ì‘ (DB ì—†ìŒ). ë‹¤ìŒ ë‹¨ê³„: í•„ë“œ ìŠ¤í‚¤ë§ˆ í™•ì • â†’ API ì—°ê²° â†’ ê¶Œí•œ/ë¡œê·¸ì¸.</div>
          <div>ğŸ—ºï¸ OpenStreetMap Geocoding: ë¬´ë£Œ API ì‚¬ìš© ì¤‘ (API í‚¤ ë¶ˆí•„ìš”)</div>
        </footer>
      </div>
    </>
  );
}
